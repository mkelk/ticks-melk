{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://ticks.sh/schemas/websocket/messages.schema.json",
  "title": "WebSocket Messages",
  "description": "Message types for the ticks.sh WebSocket protocol between local agent, cloud DO, and browser clients",
  "$defs": {
    "RunEventSource": {
      "type": "string",
      "enum": ["ralph", "swarm-orchestrator", "swarm-subagent"],
      "description": "Source of run event"
    },
    "RunEventType": {
      "type": "string",
      "enum": [
        "task-started",
        "task-update",
        "task-completed",
        "tool-activity",
        "epic-started",
        "epic-completed",
        "context-generating",
        "context-generated",
        "context-loaded",
        "context-failed",
        "context-skipped"
      ],
      "description": "Type of run event"
    },
    "TickOperationType": {
      "type": "string",
      "enum": ["add_note", "approve", "reject", "close", "reopen"],
      "description": "Type of tick operation"
    },
    "RunEventMetrics": {
      "type": "object",
      "description": "Token and cost metrics during run",
      "properties": {
        "inputTokens": { "type": "integer", "minimum": 0 },
        "outputTokens": { "type": "integer", "minimum": 0 },
        "cacheReadTokens": { "type": "integer", "minimum": 0 },
        "cacheCreationTokens": { "type": "integer", "minimum": 0 },
        "costUsd": { "type": "number", "minimum": 0 },
        "durationMs": { "type": "integer", "minimum": 0 }
      }
    },
    "RunEventTool": {
      "type": "object",
      "description": "Active tool information",
      "required": ["name"],
      "properties": {
        "name": { "type": "string" },
        "input": { "type": "string" },
        "duration": { "type": "integer", "minimum": 0 }
      }
    },
    "RunEventData": {
      "type": "object",
      "description": "Run event payload data",
      "required": ["type", "timestamp"],
      "properties": {
        "type": { "$ref": "#/$defs/RunEventType" },
        "output": { "type": "string", "description": "Current output text" },
        "status": { "type": "string", "description": "Status text" },
        "numTurns": { "type": "integer", "minimum": 0, "description": "Number of API turns" },
        "iteration": { "type": "integer", "minimum": 0 },
        "success": { "type": "boolean" },
        "message": { "type": "string", "description": "Human-readable message" },
        "taskCount": { "type": "integer", "minimum": 0, "description": "Number of tasks (context events)" },
        "tokenCount": { "type": "integer", "minimum": 0, "description": "Token count (context events)" },
        "timestamp": { "type": "string", "format": "date-time" },
        "metrics": { "$ref": "#/$defs/RunEventMetrics" },
        "activeTool": { "$ref": "#/$defs/RunEventTool" }
      }
    },
    "RunEventMessage": {
      "type": "object",
      "description": "Live run output event from local agent",
      "required": ["type", "epicId", "source", "event"],
      "properties": {
        "type": { "const": "run_event" },
        "epicId": { "type": "string", "description": "Epic being worked on" },
        "taskId": { "type": "string", "description": "Task ID (if task-level event)" },
        "source": { "$ref": "#/$defs/RunEventSource" },
        "event": { "$ref": "#/$defs/RunEventData" }
      }
    },
    "ConnectedMessage": {
      "type": "object",
      "description": "Server confirms WebSocket connection",
      "required": ["type", "connectionId"],
      "properties": {
        "type": { "const": "connected" },
        "connectionId": { "type": "string" }
      }
    },
    "ErrorMessage": {
      "type": "object",
      "description": "Error notification",
      "required": ["type", "message"],
      "properties": {
        "type": { "const": "error" },
        "message": { "type": "string" }
      }
    },
    "LocalStatusMessage": {
      "type": "object",
      "description": "Local agent online/offline status",
      "required": ["type", "connected"],
      "properties": {
        "type": { "const": "local_status" },
        "connected": { "type": "boolean" }
      }
    },
    "HeartbeatMessage": {
      "type": "object",
      "description": "Heartbeat ping",
      "required": ["type"],
      "properties": {
        "type": { "const": "heartbeat" },
        "token": { "type": "string" }
      }
    },
    "HeartbeatResponseMessage": {
      "type": "object",
      "description": "Heartbeat pong",
      "required": ["type", "expiresAt"],
      "properties": {
        "type": { "const": "heartbeat_response" },
        "expiresAt": { "type": "integer", "description": "Unix timestamp when session expires" }
      }
    },
    "StateFullMessage": {
      "type": "object",
      "description": "Full tick state on connection",
      "required": ["type", "ticks"],
      "properties": {
        "type": { "const": "state_full" },
        "ticks": {
          "type": "object",
          "additionalProperties": { "$ref": "../tick.schema.json" }
        }
      }
    },
    "TickUpdatedMessage": {
      "type": "object",
      "description": "Single tick created or updated",
      "required": ["type", "tick"],
      "properties": {
        "type": { "const": "tick_updated" },
        "tick": { "$ref": "../tick.schema.json" }
      }
    },
    "TickDeletedMessage": {
      "type": "object",
      "description": "Tick deleted",
      "required": ["type", "id"],
      "properties": {
        "type": { "const": "tick_deleted" },
        "id": { "type": "string" }
      }
    },
    "TickCreateRequest": {
      "type": "object",
      "description": "Client request to create tick",
      "required": ["type", "tick"],
      "properties": {
        "type": { "const": "tick_create" },
        "tick": { "$ref": "../tick.schema.json" }
      }
    },
    "TickUpdateRequest": {
      "type": "object",
      "description": "Client request to update tick",
      "required": ["type", "tick"],
      "properties": {
        "type": { "const": "tick_update" },
        "tick": { "$ref": "../tick.schema.json" }
      }
    },
    "TickDeleteRequest": {
      "type": "object",
      "description": "Client request to delete tick",
      "required": ["type", "id"],
      "properties": {
        "type": { "const": "tick_delete" },
        "id": { "type": "string" }
      }
    },
    "TickOperationRequest": {
      "type": "object",
      "description": "RPC request for tick operation",
      "required": ["type", "requestId", "operation", "tickId"],
      "properties": {
        "type": { "const": "tick_operation" },
        "requestId": { "type": "string" },
        "operation": { "$ref": "#/$defs/TickOperationType" },
        "tickId": { "type": "string" },
        "payload": {
          "type": "object",
          "properties": {
            "message": { "type": "string" },
            "reason": { "type": "string" }
          }
        }
      }
    },
    "TickOperationResponse": {
      "type": "object",
      "description": "RPC response for tick operation",
      "required": ["type", "requestId", "success"],
      "properties": {
        "type": { "const": "tick_operation_response" },
        "requestId": { "type": "string" },
        "success": { "type": "boolean" },
        "tick": { "$ref": "../tick.schema.json" },
        "error": { "type": "string" }
      }
    },
    "SyncFullMessage": {
      "type": "object",
      "description": "Local agent sends full tick state to DO",
      "required": ["type", "ticks"],
      "properties": {
        "type": { "const": "sync_full" },
        "ticks": {
          "type": "object",
          "additionalProperties": { "$ref": "../tick.schema.json" }
        }
      }
    },
    "ServerMessage": {
      "description": "Union of all messages sent from server/DO to clients",
      "oneOf": [
        { "$ref": "#/$defs/ConnectedMessage" },
        { "$ref": "#/$defs/ErrorMessage" },
        { "$ref": "#/$defs/LocalStatusMessage" },
        { "$ref": "#/$defs/HeartbeatResponseMessage" },
        { "$ref": "#/$defs/StateFullMessage" },
        { "$ref": "#/$defs/TickUpdatedMessage" },
        { "$ref": "#/$defs/TickDeletedMessage" },
        { "$ref": "#/$defs/TickOperationRequest" },
        { "$ref": "#/$defs/TickOperationResponse" },
        { "$ref": "#/$defs/RunEventMessage" }
      ]
    },
    "ClientMessage": {
      "description": "Union of all messages sent from clients to server/DO",
      "oneOf": [
        { "$ref": "#/$defs/HeartbeatMessage" },
        { "$ref": "#/$defs/SyncFullMessage" },
        { "$ref": "#/$defs/TickCreateRequest" },
        { "$ref": "#/$defs/TickUpdateRequest" },
        { "$ref": "#/$defs/TickDeleteRequest" },
        { "$ref": "#/$defs/TickOperationResponse" },
        { "$ref": "#/$defs/RunEventMessage" }
      ]
    }
  }
}
