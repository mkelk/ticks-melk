{
  "id": "ljx",
  "title": "Migrate cloud board UI to REST API + WebSocket hybrid",
  "description": "Refactor the cloud board UI to use the REST API for CRUD operations, with WebSocket only for real-time push updates. This unifies the code path between local and cloud boards.\n\n## Current architecture\n\n- Local board: REST API (src/api/ticks.ts) → localhost server\n- Cloud board: WebSocket only (src/api/sync.ts) → ProjectRoom DO\n\n## Target architecture\n\nBoth boards use:\n- REST API for CRUD (create, read, update, delete)\n- WebSocket (cloud) or SSE (local) for live push updates\n\n## Changes needed\n\n### 1. Update src/api/ticks.ts\n\nMake the REST client work for both local and cloud:\n\n```typescript\n// Detect mode from URL or config\nconst API_BASE = isCloudMode() \n  ? `https://tickboard.dev/api/projects/${projectId}`\n  : 'http://localhost:3000/api';\n\n// Same methods work for both\nexport async function listTicks(): Promise\u003cTick[]\u003e { ... }\nexport async function getTick(id: string): Promise\u003cTick\u003e { ... }\nexport async function updateTick(id: string, updates: Partial\u003cTick\u003e): Promise\u003cTick\u003e { ... }\nexport async function createTick(tick: NewTick): Promise\u003cTick\u003e { ... }\nexport async function deleteTick(id: string): Promise\u003cvoid\u003e { ... }\nexport async function addNote(tickId: string, content: string): Promise\u003cTick\u003e { ... }\n```\n\n### 2. Create src/api/realtime.ts\n\nThin wrapper for live updates:\n\n```typescript\ninterface RealtimeClient {\n  onTickUpdated(callback: (tick: Tick) =\u003e void): void;\n  onTickCreated(callback: (tick: Tick) =\u003e void): void;\n  onTickDeleted(callback: (id: string) =\u003e void): void;\n  connect(): Promise\u003cvoid\u003e;\n  disconnect(): void;\n}\n\n// Cloud: WebSocket to /api/projects/:project/sync\nexport function createCloudRealtime(projectId: string, token: string): RealtimeClient;\n\n// Local: SSE or polling to localhost\nexport function createLocalRealtime(port: number): RealtimeClient;\n```\n\n### 3. Update tick-board.ts component\n\nUse unified API:\n\n```typescript\n// Instead of separate code paths:\nif (this.isCloudMode) {\n  this.syncClient = new SyncClient(...);  // WebSocket only\n} else {\n  this.api = new TicksApi(...);  // REST only\n}\n\n// Unified approach:\nthis.api = createTicksApi(this.isCloudMode, projectId, token);\nthis.realtime = this.isCloudMode \n  ? createCloudRealtime(projectId, token)\n  : createLocalRealtime(port);\n\n// CRUD via REST\nawait this.api.updateTick(id, { status: 'closed' });\n\n// Live updates via realtime\nthis.realtime.onTickUpdated((tick) =\u003e this.handleTickUpdate(tick));\n```\n\n### 4. Keep WebSocket for initial sync (optional optimization)\n\nFor cloud mode, can still use WebSocket state_full message for fast initial load, then switch to REST for mutations. Or just use GET /ticks for initial load.\n\n## Benefits\n\n- Single REST client codebase\n- Third-party API = Board API (no separate implementations)\n- Easier to test (REST is simpler than WebSocket)\n- Local board could optionally add SSE for live updates too\n\n## Files to modify\n\n- src/api/ticks.ts - make work for both modes\n- src/api/realtime.ts - new file for push updates\n- src/api/sync.ts - can be deprecated/removed\n- src/components/tick-board.ts - use unified approach\n\n## Migration strategy\n\n1. Build REST API endpoints first (other tasks in this epic)\n2. Update ticks.ts to support cloud mode\n3. Create realtime.ts wrapper\n4. Update tick-board.ts to use new approach\n5. Test both local and cloud modes\n6. Remove old sync.ts code",
  "status": "open",
  "priority": 2,
  "type": "task",
  "owner": "peter@engelbrecht.dk",
  "labels": [
    "ui",
    "refactor",
    "api"
  ],
  "parent": "qr4",
  "created_by": "peter@engelbrecht.dk",
  "created_at": "2026-01-22T07:41:59.251359Z",
  "updated_at": "2026-01-22T07:41:59.251359Z"
}