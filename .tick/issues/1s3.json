{
  "id": "1s3",
  "title": "Add comprehensive auth integration tests",
  "description": "Create integration tests to verify all auth scenarios work correctly.\n\n## Test File Location\n\ncloud/worker/test/auth-integration.test.ts (or appropriate test location)\n\n## Test Scenarios\n\n### 1. WebSocket Sync Endpoint Tests\n\ndescribe('ProjectRoom WebSocket Auth', () =\u003e {\n  it('rejects connection without token', async () =\u003e {\n    const response = await fetch('/api/projects/test%2Fproject/sync', {\n      headers: { 'Upgrade': 'websocket' }\n    });\n    expect(response.status).toBe(401);\n  });\n  \n  it('rejects connection with invalid token', async () =\u003e {\n    const response = await fetch('/api/projects/test%2Fproject/sync?token=invalid', {\n      headers: { 'Upgrade': 'websocket' }\n    });\n    expect(response.status).toBe(401);\n  });\n  \n  it('rejects connection to non-owned project', async () =\u003e {\n    const token = await getValidTokenForUser('user1');\n    const response = await fetch('/api/projects/user2%2Fproject/sync?token=' + token, {\n      headers: { 'Upgrade': 'websocket' }\n    });\n    expect(response.status).toBe(403);\n  });\n  \n  it('accepts connection to owned project', async () =\u003e {\n    const token = await getValidTokenForUser('user1');\n    const response = await fetch('/api/projects/user1%2Fproject/sync?token=' + token, {\n      headers: { 'Upgrade': 'websocket' }\n    });\n    expect(response.status).toBe(101);\n  });\n});\n\n### 2. Tick Operation Tests\n\ndescribe('Tick Operation Auth', () =\u003e {\n  const operations = ['note', 'approve', 'reject', 'close', 'reopen'];\n  \n  operations.forEach(op =\u003e {\n    describe(`/ticks/:id/${op}`, () =\u003e {\n      it('returns 401 without auth', async () =\u003e {\n        const response = await fetch(`/api/projects/test/ticks/abc/${op}`, {\n          method: 'POST',\n          body: JSON.stringify({ message: 'test', reason: 'test' })\n        });\n        expect(response.status).toBe(401);\n      });\n      \n      it('returns 403 for non-owned project', async () =\u003e {\n        const response = await fetch(`/api/projects/other/ticks/abc/${op}`, {\n          method: 'POST',\n          headers: { 'Authorization': 'Bearer valid-token-user1' },\n          body: JSON.stringify({ message: 'test', reason: 'test' })\n        });\n        expect(response.status).toBe(403);\n      });\n      \n      it('succeeds for owned project', async () =\u003e {\n        const response = await fetch(`/api/projects/user1%2Fproject/ticks/abc/${op}`, {\n          method: 'POST',\n          headers: { 'Authorization': 'Bearer valid-token-user1' },\n          body: JSON.stringify({ message: 'test', reason: 'test' })\n        });\n        expect(response.status).toBe(200);\n      });\n    });\n  });\n});\n\n### 3. Debug Endpoint Tests (if kept)\n\ndescribe('Debug Endpoints', () =\u003e {\n  it('/state returns 404 (removed) or requires auth', async () =\u003e {\n    const response = await fetch('/api/projects/test/state');\n    expect([401, 404]).toContain(response.status);\n  });\n  \n  it('/connections returns 404 (removed) or requires auth', async () =\u003e {\n    const response = await fetch('/api/projects/test/connections');\n    expect([401, 404]).toContain(response.status);\n  });\n});\n\n### 4. Cross-User Isolation Tests\n\ndescribe('User Isolation', () =\u003e {\n  it('user1 cannot see user2 ticks via WebSocket', async () =\u003e {\n    // Connect as user1 to user2 project - should fail\n  });\n  \n  it('user1 cannot modify user2 ticks via API', async () =\u003e {\n    // POST to user2 project as user1 - should fail\n  });\n  \n  it('user1 state does not leak to user2 connection', async () =\u003e {\n    // Both users connect to their own projects\n    // Verify no cross-contamination\n  });\n});\n\n## Test Infrastructure Needs\n\n- Mock D1 database with test users/boards\n- Token generation for test users\n- WebSocket test client\n- Miniflare or similar for local testing\n\n## Run Command\n\nnpm test -- --grep 'Auth'\n# or\nwrangler dev --test",
  "status": "closed",
  "priority": 1,
  "type": "task",
  "owner": "peter@engelbrecht.dk",
  "blocked_by": [
    "vga",
    "ec2",
    "qqj",
    "asy"
  ],
  "parent": "5jf",
  "acceptance_criteria": "All auth integration tests pass with 100% coverage of auth paths",
  "created_by": "peter@engelbrecht.dk",
  "created_at": "2026-01-24T10:10:43.859617Z",
  "updated_at": "2026-01-24T10:43:46.287953Z",
  "closed_at": "2026-01-24T10:43:46.287953Z",
  "closed_reason": "Completed via swarm - Auth integration tests added"
}