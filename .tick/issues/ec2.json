{
  "id": "ec2",
  "title": "Add auth to tick operation API endpoints",
  "description": "Add authentication and authorization to all tick operation endpoints.\n\n## Current State (VULNERABLE)\n\nindex.ts:130-224 has these endpoints with NO authentication:\n\n- POST /api/projects/:project/ticks/:tickId/note\n- POST /api/projects/:project/ticks/:tickId/approve  \n- POST /api/projects/:project/ticks/:tickId/reject\n- POST /api/projects/:project/ticks/:tickId/close\n- POST /api/projects/:project/ticks/:tickId/reopen\n\nAll forward to ProjectRoom RPC methods without verifying the user owns the project.\n\n## Required Changes\n\nCreate a helper function to DRY up the auth pattern:\n\nasync function withProjectAuth(\n  env: Env,\n  request: Request,\n  projectId: string\n): Promise\u003c{ userId: string } | Response\u003e {\n  // Authenticate user\n  const user = await auth.getUserFromRequest(env, request);\n  if (\\!user) {\n    return jsonResponse({ error: 'Unauthorized' }, 401);\n  }\n  \n  // Verify ownership\n  const ownsProject = await auth.userOwnsProject(env, user.userId, projectId);\n  if (\\!ownsProject) {\n    return jsonResponse({ error: 'Project not found or access denied' }, 403);\n  }\n  \n  return { userId: user.userId };\n}\n\nThen update each endpoint:\n\n// Add note: POST /api/projects/:project/ticks/:tickId/note\nconst addNoteMatch = url.pathname.match(/^\\/api\\/projects\\/(.+?)\\/ticks\\/([^\\/]+)\\/note$/);\nif (addNoteMatch \u0026\u0026 request.method === 'POST') {\n  const projectId = decodeURIComponent(addNoteMatch[1]);\n  const tickId = decodeURIComponent(addNoteMatch[2]);\n\n  // ADD AUTH CHECK\n  const authResult = await withProjectAuth(env, request, projectId);\n  if (authResult instanceof Response) {\n    return authResult;\n  }\n\n  try {\n    const body = await request.json() as { message?: string };\n    // ... rest unchanged\n  }\n}\n\nApply same pattern to: approve, reject, close, reopen endpoints.\n\n## Test Cases\n\nFor each endpoint (note/approve/reject/close/reopen):\n\n1. No auth header -\u003e 401 Unauthorized\n2. Invalid token -\u003e 401 Unauthorized  \n3. Valid token, wrong project -\u003e 403 Access denied\n4. Valid token, own project -\u003e Operation succeeds\n\n## Integration Test\n\ncurl -X POST https://ticks.sh/api/projects/other-user%2Frepo/ticks/abc/approve\n# Should return 401, not success",
  "status": "closed",
  "priority": 1,
  "type": "task",
  "owner": "peter@engelbrecht.dk",
  "blocked_by": [
    "ywl"
  ],
  "parent": "5jf",
  "acceptance_criteria": "All tick operation endpoints require authentication and project ownership verification",
  "created_by": "peter@engelbrecht.dk",
  "created_at": "2026-01-24T10:09:32.57059Z",
  "updated_at": "2026-01-24T10:33:32.321399Z",
  "closed_at": "2026-01-24T10:33:32.321399Z",
  "closed_reason": "Completed via swarm - withProjectAuth helper added, all 5 tick operation endpoints now require auth"
}