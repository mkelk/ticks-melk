{
  "id": "vga",
  "title": "Add auth to ProjectRoom WebSocket sync endpoint",
  "description": "Add authentication and authorization to /api/projects/:project/sync WebSocket endpoint.\n\n## Current State (VULNERABLE)\n\nindex.ts:99-106 forwards WebSocket requests directly to ProjectRoom without any auth:\n\nconst projectSyncMatch = url.pathname.match(/^\\/api\\/projects\\/(.+?)\\/sync/);\nif (projectSyncMatch) {\n  const projectId = decodeURIComponent(projectSyncMatch[1]);\n  const doId = env.PROJECT_ROOMS.idFromName(projectId);\n  const room = env.PROJECT_ROOMS.get(doId);\n  return room.fetch(request);  // NO AUTH!\n}\n\n## Required Changes\n\n### 1. In index.ts - Add auth before forwarding\n\nconst projectSyncMatch = url.pathname.match(/^\\/api\\/projects\\/(.+?)\\/sync/);\nif (projectSyncMatch) {\n  const projectId = decodeURIComponent(projectSyncMatch[1]);\n  \n  // Extract token from query params (for WebSocket upgrade)\n  const wsUrl = new URL(request.url);\n  const token = wsUrl.searchParams.get('token');\n  \n  if (!token) {\n    return jsonResponse({ error: 'Unauthorized - token required' }, 401);\n  }\n  \n  // Validate token\n  const tokenInfo = await auth.validateToken(env, token);\n  if (!tokenInfo) {\n    return jsonResponse({ error: 'Invalid or expired token' }, 401);\n  }\n  \n  // Verify user owns this project\n  const ownsProject = await auth.userOwnsProject(env, tokenInfo.userId, projectId);\n  if (!ownsProject) {\n    return jsonResponse({ error: 'Project not found or access denied' }, 403);\n  }\n  \n  // Pass validated userId via header (like AgentHub pattern)\n  const headers = new Headers(request.headers);\n  headers.set('X-Validated-User-Id', tokenInfo.userId);\n  headers.set('X-Validated-Project-Id', projectId);\n  \n  const modifiedRequest = new Request(request.url, {\n    method: request.method,\n    headers,\n    body: request.body,\n  });\n  \n  const doId = env.PROJECT_ROOMS.idFromName(projectId);\n  const room = env.PROJECT_ROOMS.get(doId);\n  return room.fetch(modifiedRequest);\n}\n\n### 2. In project-room.ts - Accept validated user from header\n\nIn handleWebSocketUpgrade(), update to use pre-validated user:\n\n// Get pre-validated userId from main worker\nconst preValidatedUserId = request.headers.get('X-Validated-User-Id');\nif (!preValidatedUserId) {\n  return new Response('Unauthorized', { status: 401 });\n}\n\n// Remove the broken auth bypass\n// DELETE: const tokenInfo = { userId: token ? 'authenticated' : 'anonymous' };\n\n// Use the validated userId\nconst connMeta = {\n  id: connId,\n  type: connType,\n  userId: preValidatedUserId,  // Actual user ID now\n  lastSeen: Date.now(),\n};\n\n## Test Cases\n\n1. No token -\u003e 401 Unauthorized\n2. Invalid token -\u003e 401 Invalid token\n3. Valid token, wrong project -\u003e 403 Access denied\n4. Valid token, own project -\u003e WebSocket connects\n5. Connection receives userId in metadata\n6. Existing cloud sync clients continue working\n\n## Human Workflow Note\n\nAfter implementation, manually test WebSocket connection:\n1. Start local tk board\n2. Open cloud UI in browser\n3. Verify sync works for your projects\n4. Verify sync fails for other users' projects (use test account)",
  "status": "closed",
  "priority": 1,
  "type": "task",
  "owner": "peter@engelbrecht.dk",
  "blocked_by": [
    "ywl"
  ],
  "parent": "5jf",
  "acceptance_criteria": "WebSocket sync requires valid token and project ownership",
  "created_by": "peter@engelbrecht.dk",
  "created_at": "2026-01-24T10:09:18.979026Z",
  "updated_at": "2026-01-24T10:33:33.596387Z",
  "closed_at": "2026-01-24T10:33:33.596387Z",
  "closed_reason": "Completed via swarm - WebSocket sync endpoint now requires token validation and project ownership"
}