{
  "id": "qqj",
  "title": "Secure or remove debug endpoints",
  "description": "Protect the /state and /connections debug endpoints from unauthorized access.\n\n## Current State (VULNERABLE)\n\nindex.ts:108-124 exposes debug endpoints without any authentication:\n\n// /state endpoint - returns ALL ticks for ANY project\nGET /api/projects/:project/state\n\n// /connections endpoint - shows active connections\nGET /api/projects/:project/connections\n\nAnyone can dump any project's complete state.\n\n## Decision Required\n\n**Option A: Remove endpoints entirely (Recommended)**\n- Safest approach\n- Debug can be done via DO logs or wrangler tail\n- Removes attack surface completely\n\n**Option B: Add authentication + admin-only**\n- Keep for debugging but require:\n  - Valid authentication\n  - Project ownership verification\n  - Optional: Admin role check\n\n## Implementation (Option A - Recommended)\n\nSimply remove or comment out these routes in index.ts:\n\n// REMOVED: Debug endpoints - security risk\n// If needed, use wrangler tail or DO logging\n/*\nconst projectStateMatch = url.pathname.match(/^\\/api\\/projects\\/(.+?)\\/state/);\nif (projectStateMatch) { ... }\n\nconst projectConnsMatch = url.pathname.match(/^\\/api\\/projects\\/(.+?)\\/connections/);\nif (projectConnsMatch) { ... }\n*/\n\nAlso remove the corresponding handlers in project-room.ts fetch():\n\n// REMOVED: Debug endpoints\n/*\nif (url.pathname.endsWith('/state') \u0026\u0026 request.method === 'GET') { ... }\nif (url.pathname.endsWith('/connections') \u0026\u0026 request.method === 'GET') { ... }\n*/\n\n## Implementation (Option B - If keeping)\n\nconst projectStateMatch = url.pathname.match(/^\\/api\\/projects\\/(.+?)\\/state/);\nif (projectStateMatch) {\n  const projectId = decodeURIComponent(projectStateMatch[1]);\n  \n  const user = await auth.getUserFromRequest(env, request);\n  if (!user) {\n    return jsonResponse({ error: 'Unauthorized' }, 401);\n  }\n  \n  const ownsProject = await auth.userOwnsProject(env, user.userId, projectId);\n  if (!ownsProject) {\n    return jsonResponse({ error: 'Project not found or access denied' }, 403);\n  }\n  \n  const doId = env.PROJECT_ROOMS.idFromName(projectId);\n  const room = env.PROJECT_ROOMS.get(doId);\n  return room.fetch(request);\n}\n\n## Test Cases\n\n**If removing:**\n- GET /api/projects/any/state -\u003e 404 Not Found\n- GET /api/projects/any/connections -\u003e 404 Not Found\n\n**If securing:**\n- No auth -\u003e 401\n- Wrong project -\u003e 403  \n- Own project -\u003e Returns data\n\n## Human Decision Point\n\nDecide whether to remove or secure these endpoints before implementing.",
  "notes": "2026-01-24 11:30 - Agent skipped: Task requires human decision between Option A (remove endpoints) and Option B (add authentication). Please make a decision and mark as agent_ready.\n2026-01-24 11:57 - [human] Decision: Remove debug endpoints entirely (Option A). This is the safest approach.",
  "status": "closed",
  "priority": 1,
  "type": "task",
  "owner": "peter@engelbrecht.dk",
  "blocked_by": [
    "ywl"
  ],
  "parent": "5jf",
  "acceptance_criteria": "Debug endpoints either removed or require authentication",
  "created_by": "peter@engelbrecht.dk",
  "created_at": "2026-01-24T10:09:48.216828Z",
  "updated_at": "2026-01-24T10:58:38.397572Z",
  "closed_at": "2026-01-24T10:58:38.397572Z",
  "closed_reason": "Removed debug endpoints (/state, /connections) from both index.ts and project-room.ts. Added comments noting to use wrangler tail for debugging."
}