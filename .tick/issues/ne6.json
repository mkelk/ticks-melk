{
  "id": "ne6",
  "title": "Add authentication for DO WebSocket connections",
  "description": "Secure DO connections with token authentication.\n\n## Token Validation\n\nIn DO:\n```typescript\nasync handleWebSocket(request: Request): Promise\u003cResponse\u003e {\n    const url = new URL(request.url)\n    const token = url.searchParams.get('token')\n    \n    if (!token) {\n        return new Response('Missing token', { status: 401 })\n    }\n    \n    // Validate token against KV store\n    const userId = await this.validateToken(token)\n    if (!userId) {\n        return new Response('Invalid token', { status: 403 })\n    }\n    \n    // Check project access\n    const projectId = this.getProjectId()\n    const hasAccess = await this.checkProjectAccess(userId, projectId)\n    if (!hasAccess) {\n        return new Response('Access denied', { status: 403 })\n    }\n    \n    // Proceed with WebSocket\n    return this.setupWebSocket(request, userId)\n}\n\nasync validateToken(token: string): Promise\u003cstring | null\u003e {\n    const data = await this.env.TOKENS.get(token)\n    if (!data) return null\n    \n    const { userId, expiresAt } = JSON.parse(data)\n    if (new Date(expiresAt) \u003c new Date()) return null\n    \n    return userId\n}\n```\n\n## Project Access Model\n\n```typescript\n// KV: PROJECT_ACCESS\n// Key: {userId}:{projectId}\n// Value: { role: 'owner' | 'member', grantedAt: timestamp }\n\nasync checkProjectAccess(userId: string, projectId: string): Promise\u003cboolean\u003e {\n    const key = `${userId}:${projectId}`\n    const access = await this.env.PROJECT_ACCESS.get(key)\n    return access !== null\n}\n```\n\n## Token Generation\n\nVia tickboard.dev settings:\n```typescript\n// POST /api/tokens\nasync function createToken(userId: string): Promise\u003cstring\u003e {\n    const token = crypto.randomUUID()\n    const expiresAt = new Date(Date.now() + 365 * 24 * 60 * 60 * 1000) // 1 year\n    \n    await env.TOKENS.put(token, JSON.stringify({\n        userId,\n        expiresAt: expiresAt.toISOString()\n    }), {\n        expirationTtl: 365 * 24 * 60 * 60\n    })\n    \n    return token\n}\n```\n\n## Local Client Auth\n\n```go\nfunc (c *Client) Connect(ctx context.Context) error {\n    if c.token == \"\" {\n        return fmt.Errorf(\"authentication required\")\n    }\n    \n    url := fmt.Sprintf(\"%s/%s/sync?token=%s\u0026type=local\",\n        c.cloudURL, c.projectID, c.token)\n    \n    conn, resp, err := websocket.DefaultDialer.DialContext(ctx, url, nil)\n    if err != nil {\n        if resp != nil \u0026\u0026 resp.StatusCode == 401 {\n            return fmt.Errorf(\"invalid or expired token\")\n        }\n        if resp != nil \u0026\u0026 resp.StatusCode == 403 {\n            return fmt.Errorf(\"access denied to project\")\n        }\n        return err\n    }\n    \n    c.conn = conn\n    return nil\n}\n```",
  "status": "closed",
  "priority": 2,
  "type": "task",
  "owner": "peter@engelbrecht.dk",
  "parent": "y1i",
  "created_by": "peter@engelbrecht.dk",
  "created_at": "2026-01-21T16:32:10.285442Z",
  "updated_at": "2026-01-21T18:51:55.756296Z",
  "closed_at": "2026-01-21T18:51:55.756296Z",
  "closed_reason": "DO auth already implemented in project-room.ts (token validation, project access check, 401/403 responses). Updated Go client Connect() to handle auth errors with specific messages for 401 (missing/invalid token) and 403 (access denied/expired). Auth flow: token in query param → validateToken() → userOwnsBoard() → WebSocket upgrade."
}