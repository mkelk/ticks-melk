{
  "id": "fq8",
  "title": "Update cloud UI to connect to DO directly",
  "description": "Update web UI to use DO WebSocket instead of relay.\n\n## Changes to UI\n\n### New WebSocket Client\n```typescript\n// src/api/sync.ts\nexport class SyncClient {\n  private ws: WebSocket | null = null\n  private projectId: string\n  private onUpdate: (ticks: Map\u003cstring, Tick\u003e) =\u003e void\n\n  constructor(projectId: string, onUpdate: (ticks: Map\u003cstring, Tick\u003e) =\u003e void) {\n    this.projectId = projectId\n    this.onUpdate = onUpdate\n  }\n\n  connect() {\n    const url = `wss://tickboard.dev/api/projects/${this.projectId}/sync?type=cloud`\n    this.ws = new WebSocket(url)\n    \n    this.ws.onmessage = (event) =\u003e {\n      const msg = JSON.parse(event.data)\n      this.handleMessage(msg)\n    }\n    \n    this.ws.onclose = () =\u003e {\n      // Reconnect with backoff\n      setTimeout(() =\u003e this.connect(), 1000)\n    }\n  }\n\n  handleMessage(msg: any) {\n    switch (msg.type) {\n      case 'state_full':\n        this.onUpdate(new Map(Object.entries(msg.ticks)))\n        break\n      case 'tick_updated':\n      case 'tick_created':\n        // Update single tick in state\n        this.onTickUpdate(msg.tick)\n        break\n      case 'tick_deleted':\n        this.onTickDelete(msg.id)\n        break\n    }\n  }\n\n  // Send updates to DO\n  updateTick(tick: Tick) {\n    this.send({ type: 'tick_update', tick })\n  }\n\n  createTick(tick: Tick) {\n    this.send({ type: 'tick_create', tick })\n  }\n\n  deleteTick(id: string) {\n    this.send({ type: 'tick_delete', id })\n  }\n\n  private send(msg: any) {\n    if (this.ws?.readyState === WebSocket.OPEN) {\n      this.ws.send(JSON.stringify(msg))\n    }\n  }\n}\n```\n\n### Update tick-board.ts\n\nReplace current API polling/relay with sync client:\n\n```typescript\n// src/components/tick-board.ts\nimport { SyncClient } from '../api/sync'\n\nexport class TickBoard extends LitElement {\n  private syncClient: SyncClient | null = null\n  \n  connectedCallback() {\n    super.connectedCallback()\n    \n    // Get project ID from URL or config\n    const projectId = this.getProjectId()\n    \n    this.syncClient = new SyncClient(projectId, (ticks) =\u003e {\n      this.ticks = ticks\n      this.requestUpdate()\n    })\n    \n    this.syncClient.connect()\n  }\n\n  // When user edits a tick\n  async handleTickUpdate(tick: Tick) {\n    // Optimistic update\n    this.ticks.set(tick.id, tick)\n    this.requestUpdate()\n    \n    // Send to DO (will broadcast back to confirm)\n    this.syncClient?.updateTick(tick)\n  }\n}\n```\n\n### Remove Old Relay Code\n\nDelete or deprecate:\n- src/api/ticks.ts (polling-based API)\n- SSE event handling\n- Relay-specific error handling\n\n## Authentication\n\nProject access via token in URL or header:\n```typescript\nconnect() {\n  const token = localStorage.getItem('tickboard_token')\n  const url = `wss://tickboard.dev/api/projects/${this.projectId}/sync?token=${token}\u0026type=cloud`\n  // ...\n}\n```\n\nDO validates token before accepting connection.",
  "status": "closed",
  "priority": 2,
  "type": "task",
  "owner": "peter@engelbrecht.dk",
  "parent": "y1i",
  "created_by": "peter@engelbrecht.dk",
  "created_at": "2026-01-21T16:31:36.015815Z",
  "updated_at": "2026-01-21T18:44:50.009631Z",
  "closed_at": "2026-01-21T18:44:50.009631Z",
  "closed_reason": "Added SyncClient (src/api/sync.ts) for WebSocket connection to DO. Updated tick-board.ts with: cloud mode detection (URL path, localStorage, hostname), SyncClient integration for real-time state sync, tickToBoardTick converter for computed fields. Cloud mode auto-detected from /p/\u003cproject\u003e URL pattern or tickboard.dev hostname."
}