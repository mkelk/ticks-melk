{
  "id": "r2e",
  "title": "Implement acknowledged writes with local sync confirmation",
  "description": "Implement write acknowledgment so API callers know when changes have actually reached the local .tick/ files.\n\n## Problem\n\ncanWrite: true is a point-in-time check. Local can disconnect between:\n1. DO receives API write\n2. DO broadcasts to local\n3. Local writes to disk\n\nResult: API returns 200 but change never reaches repo.\n\n## Solution: Acknowledged writes\n\n### Write flow with ack\n\n```\nAPI PATCH /ticks/:id\n    ↓\nDO generates ackId\n    ↓\nDO sends: { type: \"tick_update\", tick, ackId: \"abc123\" }\n    ↓\nDO waits for ack (with timeout)\n    ↓\nLocal writes to .tick/issues/abc.json\n    ↓\nLocal sends: { type: \"ack\", ackId: \"abc123\", success: true }\n    ↓\nDO receives ack\n    ↓\nAPI returns 200 OK\n```\n\n### Message types\n\n```typescript\n// DO → Local\ninterface SyncMessageWithAck {\n  type: \"tick_update\" | \"tick_create\" | \"tick_delete\";\n  tick?: Tick;\n  id?: string;  // for delete\n  ackId: string;  // unique ID for this operation\n}\n\n// Local → DO\ninterface AckMessage {\n  type: \"ack\";\n  ackId: string;\n  success: boolean;\n  error?: string;  // if success: false\n}\n```\n\n### DO implementation\n\n```typescript\nprivate pendingAcks: Map\u003cstring, {\n  resolve: (success: boolean) =\u003e void;\n  reject: (error: Error) =\u003e void;\n  timeout: ReturnType\u003ctypeof setTimeout\u003e;\n}\u003e = new Map();\n\nasync writeWithAck(msg: SyncMessageWithAck, timeoutMs = 5000): Promise\u003cboolean\u003e {\n  const ackId = crypto.randomUUID();\n  msg.ackId = ackId;\n  \n  return new Promise((resolve, reject) =\u003e {\n    const timeout = setTimeout(() =\u003e {\n      this.pendingAcks.delete(ackId);\n      reject(new Error(\"Ack timeout - local may be offline\"));\n    }, timeoutMs);\n    \n    this.pendingAcks.set(ackId, { resolve, reject, timeout });\n    \n    // Send to local connection only\n    if (this.localConnection) {\n      this.localConnection.socket.send(JSON.stringify(msg));\n    } else {\n      clearTimeout(timeout);\n      this.pendingAcks.delete(ackId);\n      reject(new Error(\"Local not connected\"));\n    }\n  });\n}\n\n// In webSocketMessage handler:\nif (msg.type === \"ack\") {\n  const pending = this.pendingAcks.get(msg.ackId);\n  if (pending) {\n    clearTimeout(pending.timeout);\n    this.pendingAcks.delete(msg.ackId);\n    if (msg.success) {\n      pending.resolve(true);\n    } else {\n      pending.reject(new Error(msg.error || \"Local write failed\"));\n    }\n  }\n}\n```\n\n### Go client (tk run) implementation\n\n```go\n// In handleTickUpdate:\nfunc (c *Client) handleTickUpdate(msg TickUpdateMessage) {\n    // Write to local file\n    err := c.store.Write(msg.Tick)\n    \n    // Send ack\n    ack := AckMessage{\n        Type:    \"ack\",\n        AckID:   msg.AckID,\n        Success: err == nil,\n    }\n    if err != nil {\n        ack.Error = err.Error()\n    }\n    c.conn.WriteJSON(ack)\n}\n```\n\n### API behavior\n\n```typescript\n// In PATCH handler:\ntry {\n  // Update in-memory\n  this.ticks.set(tickId, updated);\n  \n  // Wait for local ack\n  await this.writeWithAck({ type: \"tick_update\", tick: updated });\n  \n  // Persist after confirmed\n  await this.persistState();\n  \n  // Broadcast to cloud clients (they see it after local confirmed)\n  this.broadcast({ type: \"tick_updated\", tick: updated }, this.localConnection?.id);\n  \n  return Response.json({ \n    tick: updated,\n    _sync: { ...getSyncStatus(), confirmed: true }\n  });\n  \n} catch (err) {\n  // Rollback in-memory change\n  this.ticks.set(tickId, originalTick);\n  \n  return Response.json({\n    error: \"Failed to sync to local\",\n    code: \"SYNC_FAILED\",\n    details: err.message,\n    _sync: getSyncStatus(),\n  }, { status: 503 });\n}\n```\n\n### Response examples\n\nSuccess (confirmed):\n```json\n{\n  \"tick\": { ... },\n  \"_sync\": {\n    \"localConnected\": true,\n    \"confirmed\": true\n  }\n}\n```\n\nFailure (local offline or write failed):\n```json\n{\n  \"error\": \"Failed to sync to local\",\n  \"code\": \"SYNC_FAILED\",\n  \"details\": \"Ack timeout - local may be offline\",\n  \"_sync\": {\n    \"localConnected\": false,\n    \"confirmed\": false\n  }\n}\n```\n\n### Timeout handling\n\n- Default timeout: 5 seconds\n- On timeout: return 504 Gateway Timeout\n- Client should retry or check status\n\n## Files to modify\n\n- cloud/worker/src/project-room.ts (DO ack handling)\n- internal/tickboard/cloud/client.go (Go ack sending)",
  "status": "open",
  "priority": 1,
  "type": "task",
  "owner": "peter@engelbrecht.dk",
  "labels": [
    "api",
    "sync",
    "reliability"
  ],
  "parent": "qr4",
  "created_by": "peter@engelbrecht.dk",
  "created_at": "2026-01-22T07:49:23.481078Z",
  "updated_at": "2026-01-22T07:49:23.481078Z"
}