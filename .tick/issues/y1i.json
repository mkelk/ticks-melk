{
  "id": "y1i",
  "title": "Real-time cloud board with Durable Objects sync",
  "description": "Overhaul tickboard.dev architecture for real-time responsiveness. Replace WebSocket relay with Durable Objects sync hub. Absorb tk board into tk run.\n\n## Problem\n\nCurrent cloud board experience is sluggish:\n- Every interaction relays through WebSocket to local server\n- 200-500ms+ latency per action\n- Connection drops cause state issues\n- tk board and tk run are separate processes that can conflict\n\n## Solution\n\n1. **DO as sync hub**: Real-time bidirectional sync between local and cloud\n2. **Absorb board into run**: Single process handles agent + UI + sync\n3. **Static UI on Pages**: No relay needed for reads, instant load\n\n## Architecture\n\n```\n┌──────────────────────────────────────────────────────────────────┐\n│                                                                  │\n│  tk run epic --board --cloud                                     │\n│       │                                                          │\n│       ├── Agent execution                                        │\n│       ├── Local board UI (:3000)                                 │\n│       ├── File watcher (.tick/)                                  │\n│       └── WebSocket to DO ◄──────────┐                           │\n│              │                       │                           │\n│              ▼                       │                           │\n│   ┌─────────────────────┐           │                           │\n│   │   Durable Object    │           │                           │\n│   │   (per project)     │           │                           │\n│   │                     │           │                           │\n│   │  - tick state       │◄──────────┼─── Cloud UI (Pages)       │\n│   │  - connections[]    │           │    (static, fast)         │\n│   │  - broadcast()      │───────────┘                           │\n│   └─────────────────────┘                                        │\n│                                                                  │\n└──────────────────────────────────────────────────────────────────┘\n```\n\n## Command Changes\n\n### Before\n```bash\ntk board              # standalone board\ntk board --cloud      # board with cloud relay\ntk run \u003cepic\u003e         # agent only\n```\n\n### After\n```bash\ntk run \u003cepic\u003e                    # agent only (current)\ntk run \u003cepic\u003e --board            # agent + local board\ntk run \u003cepic\u003e --board --cloud    # agent + board + DO sync\ntk run --board                   # board only, no agent (replaces tk board)\ntk run --board --cloud           # board + DO sync, no agent\n```\n\nOr simpler flag: `--cloud` implies `--board`\n```bash\ntk run \u003cepic\u003e --cloud            # agent + board + sync\ntk run --cloud                   # board + sync, no agent (review mode)\n```\n\n### Deprecation\n```bash\ntk board              # warns: \"deprecated, use: tk run --board\"\ntk board --cloud      # warns: \"deprecated, use: tk run --cloud\"\n```\n\n## Durable Object Design\n\n### State\n```typescript\ninterface ProjectState {\n  ticks: Map\u003cstring, Tick\u003e\n  connections: Map\u003cstring, WebSocket\u003e  // id -\u003e socket\n  lastUpdated: Map\u003cstring, number\u003e     // tick id -\u003e timestamp\n}\n```\n\n### Messages\n```typescript\n// Local → DO\n{ type: \"sync_full\", ticks: Tick[] }           // initial sync\n{ type: \"tick_update\", tick: Tick }            // single tick change\n{ type: \"tick_create\", tick: Tick }\n{ type: \"tick_delete\", id: string }\n\n// DO → Clients\n{ type: \"tick_updated\", tick: Tick }           // broadcast\n{ type: \"tick_created\", tick: Tick }\n{ type: \"tick_deleted\", id: string }\n{ type: \"state_full\", ticks: Tick[] }          // initial state for new client\n```\n\n### Conflict Resolution\nLast-write-wins based on `updatedAt` timestamp:\n```typescript\nonTickUpdate(tick: Tick, source: string) {\n  const existing = this.ticks.get(tick.id)\n  if (!existing || tick.updatedAt \u003e existing.updatedAt) {\n    this.ticks.set(tick.id, tick)\n    this.broadcast({ type: \"tick_updated\", tick }, exclude: source)\n  }\n}\n```\n\n## Sync Flow\n\n### Local → Cloud\n1. fsnotify detects .tick/issues/*.json change\n2. Load tick, compare timestamp\n3. Send to DO if newer\n4. DO broadcasts to cloud UI\n\n### Cloud → Local\n1. User edits in cloud UI\n2. Cloud UI sends to DO\n3. DO validates, updates state\n4. DO broadcasts to local\n5. Local writes to .tick/issues/*.json\n\n### Startup Sync\n1. tk run connects to DO\n2. Sends full state: all ticks with timestamps\n3. DO merges (newer wins)\n4. DO sends back merged state\n5. Local applies any changes from cloud\n\n## Static UI Deployment\n\n### Build \u0026 Deploy\n```yaml\n# .github/workflows/release.yml\n- name: Build UI\n  run: cd internal/tickboard/ui \u0026\u0026 npm run build\n\n- name: Deploy to Pages\n  uses: cloudflare/pages-action@v1\n  with:\n    directory: internal/tickboard/ui/dist\n    projectName: tickboard\n```\n\n### URL Structure\n- `tickboard.dev` → static Pages UI\n- `tickboard.dev/api/*` → Worker (DO access)\n- `attachments.tickboard.dev` → R2 bucket\n\n## Migration Path\n\n### Phase 1: Absorb board into run\n- Add --board flag to tk run\n- Deprecate tk board (keep working, show warning)\n- No cloud changes yet\n\n### Phase 2: DO sync infrastructure\n- Implement DO for project state\n- Update cloud client to use DO\n- Deploy static UI to Pages\n\n### Phase 3: Deprecate relay\n- Remove WebSocket relay code\n- Full DO-based sync\n- Remove tk board command entirely\n\n## Benefits\n\n| Aspect | Before | After |\n|--------|--------|-------|\n| Read latency | 200-500ms | \u003c50ms (static) |\n| Write latency | 200-500ms | 50-100ms (DO) |\n| Reliability | WebSocket drops | DO reconnects |\n| Offline | Broken | Local works, syncs on reconnect |\n| Complexity | Two processes | One process |\n\n## Not In Scope\n\n- Multi-user collaboration (same project, different users)\n- Offline cloud UI (would need service worker + IndexedDB)\n- Real-time cursors/presence",
  "status": "open",
  "priority": 1,
  "type": "epic",
  "owner": "peter@engelbrecht.dk",
  "labels": [
    "feature",
    "infrastructure",
    "cloud"
  ],
  "created_by": "peter@engelbrecht.dk",
  "created_at": "2026-01-21T16:29:51.416497Z",
  "updated_at": "2026-01-21T16:29:51.416497Z"
}