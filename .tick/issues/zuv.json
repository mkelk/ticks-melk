{
  "id": "zuv",
  "title": "Add REST route forwarding in index.ts",
  "description": "Add route handling in the main worker to forward tick API requests to ProjectRoom DO.\n\n## Routes to add\n\n```typescript\n// In index.ts handleRequest():\n\n// Tick API: /api/projects/:project/ticks/*\nconst tickApiMatch = url.pathname.match(/^\\/api\\/projects\\/([^\\/]+)\\/ticks(\\/.*)?$/);\nif (tickApiMatch) {\n  const projectId = decodeURIComponent(tickApiMatch[1]);\n  \n  // Validate auth first (in main worker, not DO)\n  const authHeader = request.headers.get(\"Authorization\");\n  const token = authHeader?.replace(\"Bearer \", \"\");\n  if (!token) {\n    return jsonResponse({ error: \"Missing authorization\" }, 401);\n  }\n  \n  const tokenInfo = await auth.validateToken(env, token);\n  if (!tokenInfo) {\n    return jsonResponse({ error: \"Invalid token\" }, 401);\n  }\n  \n  const hasAccess = await auth.userOwnsBoard(env, tokenInfo.userId, projectId);\n  if (!hasAccess) {\n    return jsonResponse({ error: \"Access denied\" }, 403);\n  }\n  \n  // Forward to ProjectRoom with validated userId in header\n  const doId = env.PROJECT_ROOMS.idFromName(projectId);\n  const room = env.PROJECT_ROOMS.get(doId);\n  \n  const headers = new Headers(request.headers);\n  headers.set(\"X-User-Id\", tokenInfo.userId);\n  \n  return room.fetch(new Request(request.url, {\n    method: request.method,\n    headers,\n    body: request.body,\n  }));\n}\n```\n\n## Key points\n\n- Auth happens in main worker (not in DO) to avoid D1 calls inside DO\n- Pass validated userId via header for audit logging\n- Reuse existing jsonResponse helper\n- Place before other route handlers\n\n## Files to modify\n\n- `cloud/worker/src/index.ts`",
  "status": "open",
  "priority": 1,
  "type": "task",
  "owner": "peter@engelbrecht.dk",
  "labels": [
    "worker",
    "routing"
  ],
  "parent": "qr4",
  "created_by": "peter@engelbrecht.dk",
  "created_at": "2026-01-22T07:32:33.421928Z",
  "updated_at": "2026-01-22T07:32:33.421928Z"
}