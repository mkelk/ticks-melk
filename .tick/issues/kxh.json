{
  "id": "kxh",
  "title": "Add session expiry and re-auth for long-lived WebSocket connections",
  "description": "Implement token expiry checking for long-lived WebSocket connections.\n\n## Problem\n\nWebSocket connections can stay open indefinitely. If a user's token is revoked, their connection should be terminated.\n\n## Implementation Options\n\n### Option 1: Periodic Token Re-Validation (Recommended)\n\nIn ProjectRoom, periodically check if connections are still valid:\n\n// In alarm() method, add token re-validation\nasync alarm() {\n  // ... existing cleanup code ...\n  \n  // Re-validate long-lived connections (every 5 minutes)\n  for (const [id, conn] of this.connections) {\n    if (conn.type === 'cloud' \u0026\u0026 conn.tokenId) {\n      const isValid = await this.validateTokenStillValid(conn.tokenId);\n      if (\\!isValid) {\n        console.log(`[ProjectRoom] Token revoked, closing connection ${id}`);\n        conn.socket.close(4001, 'Token revoked');\n        this.connections.delete(id);\n      }\n    }\n  }\n}\n\nChallenge: DO can't call D1 directly. Need to call back to worker.\n\n### Option 2: Token Expiry in Claims\n\nInclude expiry time in the validated claims passed to DO:\n\n// In worker, add expiry to header\nheaders.set('X-Token-Expires-At', String(tokenInfo.expiresAt || Date.now() + 3600000));\n\n// In DO, check expiry\nif (conn.expiresAt \u0026\u0026 Date.now() \u003e conn.expiresAt) {\n  conn.socket.close(4001, 'Session expired');\n}\n\n### Option 3: Heartbeat with Re-Auth\n\nRequire clients to send periodic auth heartbeats:\n\n// Client sends every 5 minutes\nws.send(JSON.stringify({ type: 'heartbeat', token: currentToken }));\n\n// Server validates and extends session\ncase 'heartbeat':\n  // Call back to worker to validate token\n  break;\n\n## Recommended Approach\n\nCombine Option 2 and 3:\n1. Set token expiry to 1 hour from auth\n2. Client refreshes token before expiry\n3. Client sends heartbeat with new token\n4. Server validates and updates expiry\n\n## Connection Metadata Update\n\ninterface Connection {\n  id: string;\n  socket: WebSocket;\n  type: 'local' | 'cloud';\n  userId: string;\n  tokenId?: string;     // Track which token authenticated this\n  expiresAt?: number;   // When the session expires\n  lastSeen: number;\n}\n\n## Test Cases\n\n1. Connection with expired token -\u003e Closed by server\n2. Connection sends valid heartbeat -\u003e Extended\n3. Connection sends invalid heartbeat -\u003e Closed\n4. Revoked token (if checking) -\u003e Closed\n\n## Note\n\nThis is a medium-priority enhancement. The main auth fixes are more critical.",
  "status": "closed",
  "priority": 2,
  "type": "task",
  "owner": "peter@engelbrecht.dk",
  "blocked_by": [
    "thb"
  ],
  "parent": "5jf",
  "acceptance_criteria": "Long-lived connections are terminated when tokens expire or are revoked",
  "created_by": "peter@engelbrecht.dk",
  "created_at": "2026-01-24T10:11:32.617027Z",
  "updated_at": "2026-01-24T10:43:46.973786Z",
  "closed_at": "2026-01-24T10:43:46.973786Z",
  "closed_reason": "Completed via swarm - Session expiry and token validation added for WebSocket connections"
}